name: Build Flutter APK (Release)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # (اختياري) لو مشروعك ما فيه مجلد android تم إنشاؤه قبل
      - name: Ensure Android platform exists
        run: |
          if [ ! -d android ]; then
            flutter create .
          fi

      - name: Flutter clean & pub get
        run: |
          flutter clean
          flutter pub get

      # يكتب build.gradle جديد في android/app/ مع إعدادات حديثة وتوقيع افتراضي
      - name: Patch android/app/build.gradle
        shell: bash
        run: |
          mkdir -p android/app
          cat > android/app/build.gradle <<'EOF'
          plugins {
              id "com.android.application"
              id "kotlin-android"
              // Flutter Gradle plugin (حديث)
              id "dev.flutter.flutter-gradle-plugin"
          }

          android {
              namespace "com.example.bbk_ai"
              compileSdk 34

              defaultConfig {
                  applicationId "com.example.bbk_ai"
                  minSdk 21
                  targetSdk 34
                  versionCode 1
                  versionName "1.0"
                  multiDexEnabled true
              }

              signingConfigs {
                  // نستخدم debug keystore للتوقيع الافتراضي على CI
                  debug {
                      storeFile file(System.getenv("HOME") + "/.android/debug.keystore")
                      storePassword "android"
                      keyAlias "androiddebugkey"
                      keyPassword "android"
                  }
                  release {
                      storeFile file(System.getenv("HOME") + "/.android/debug.keystore")
                      storePassword "android"
                      keyAlias "androiddebugkey"
                      keyPassword "android"
                  }
              }

              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      // نوقف التصغير عشان نتجنب أخطاء R8 مؤقتاً
                      minifyEnabled false
                      shrinkResources false
                  }
              }

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_17
                  targetCompatibility JavaVersion.VERSION_17
              }
              kotlinOptions {
                  jvmTarget = '17'
              }
          }

          dependencies {
              implementation 'androidx.multidex:multidex:2.0.1'
          }
          EOF

      - name: Build APK (release)
        run: flutter build apk --release --verbose

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: bbk_ai-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk
